(function($){"use strict";class AttributesAdmin{constructor(config){this.config=$.extend({},AttributesAdmin.defaults,config);this.notificationManager=new NotificationManager;this.isProcessing=false;this.form=$(".attrua-settings-form");this.submitButton=this.form.find(":submit");this.initializeEventListeners()}initializeEventListeners(){$(document).on("click",".attrua-create-page",this.handlePageCreation.bind(this));$(document).on("click",".attrua-delete-page",this.handlePageDeletion.bind(this));$(document).on("change",".attrua-redirect-toggle input",this.handleRedirectToggle.bind(this));this.form.on("submit",this.handleFormSubmission.bind(this));$(document).on("click",".notice-dismiss",function(){$(this).closest(".notice").fadeOut()});$(document).on("change click",".attrua-redirect-toggle input, .attrua-redirect-toggle .slider",e=>{if(e.target.classList.contains("slider")){const checkbox=$(e.target).siblings('input[type="checkbox"]');checkbox.prop("checked",!checkbox.prop("checked")).trigger("change");e.preventDefault()}else{this.handleRedirectToggle(e)}});$(document).on("click",".attrua-copy-shortcode",function(e){e.preventDefault();const shortcode=$(this).data("shortcode");const button=$(this);const textarea=document.createElement("textarea");textarea.value=shortcode;document.body.appendChild(textarea);textarea.select();document.execCommand("copy");document.body.removeChild(textarea);button.html('<i class="ti ti-check"></i>');setTimeout(()=>{button.html('<i class="ti ti-copy"></i>')},2e3)})}handlePageCreation(event){event.preventDefault();if(this.isProcessing){return}const button=$(event.currentTarget);const pageType=button.data("page-type");const table=button.closest(".attrua-pages-table");const pageTitle=table.find(".attrua-page-title").val();const pageSlug=table.find(".attrua-page-slug").val();if(!pageType||!pageTitle){this.showError(this.config.i18n.invalidData);return}this.isProcessing=true;button.prop("disabled",true).text(this.config.i18n.creatingPage);button.data("original-text",button.text());$.ajax({url:this.config.ajax_url,type:"POST",data:{action:"attrua_create_page",_ajax_nonce:this.config.nonce,page_type:pageType,title:pageTitle,slug:pageSlug},success:this.handlePageCreationSuccess.bind(this,button),error:this.handleAjaxError.bind(this,button)})}handlePageCreationSuccess(button,response){if(!response.success){this.handleAjaxError(button,response);return}const pageRow=button.closest(".attrua-page-row");const pageType=response.data.page_type;const pageId=response.data.page_id;const titleInput=pageRow.find(".attrua-page-title");const titleDisplay=$('<strong class="attrua-page-title-display"></strong>').text(titleInput.val());titleInput.hide().after(titleDisplay);const slugInput=pageRow.find(".attrua-page-slug");const slugDisplay=$('<strong class="attrua-page-slug-display"></strong>').html('<span class="attrua-page-prefix">/</span> '+slugInput.val());slugInput.hide().after(slugDisplay);const shortCode=pageRow.find(".attrua-page-shortcode").parent();shortCode.html(this.getShortCodeTemplate(response.data));pageRow.find(".attrua-page-shortcode").show();const pageControl=button.closest(".attrua-page-control");pageControl.html(this.getPageActionsTemplate(response.data));const redirectCell=pageRow.find(".attrua-redirect-toggle").parent();redirectCell.html(this.getPageRedirectTemplate(response.data));this.showSuccess(this.config.i18n.pageCreated);this.isProcessing=false}handlePageDeletion(event){event.preventDefault();if(this.isProcessing){return}const button=$(event.currentTarget);const pageId=button.data("page-id");const pageType=button.data("page-type");if(!confirm(this.config.i18n.confirmDelete)){return}this.isProcessing=true;button.prop("disabled",true).text(this.config.i18n.deletingPage);$.ajax({url:this.config.ajax_url,type:"POST",data:{action:"attrua_delete_page",_ajax_nonce:this.config.nonce,page_id:pageId,page_type:pageType},success:this.handlePageDeletionSuccess.bind(this,button,pageType),error:this.handleAjaxError.bind(this,button)})}handlePageDeletionSuccess(button,pageType,response){if(!response.success){this.handleAjaxError(button,response);return}const pageRow=button.closest(".attrua-page-row");const titleInput=pageRow.find(".attrua-page-title");const titleDisplay=pageRow.find(".attrua-page-title-display");const slugInput=pageRow.find(".attrua-page-slug");const slugDisplay=pageRow.find(".attrua-page-slug-display");const shortcodeDisplay=pageRow.find(".attrua-page-shortcode");const redirectToggle=pageRow.find(".attrua-redirect-toggle");const redirectCheckbox=redirectToggle.find('input[type="checkbox"]');titleDisplay.remove();titleInput.css("display","").show().val(titleInput.attr("placeholder"));slugDisplay.remove();slugInput.css("display","").show().val(slugInput.attr("placeholder"));shortcodeDisplay.hide();redirectCheckbox.prop("checked",false);redirectToggle.hide();const pageControl=button.closest(".attrua-page-control");const template=this.getCreateButtonTemplate(pageType);pageControl.html(template);this.showSuccess(this.config.i18n.pageDeleted);this.isProcessing=false}handleRedirectToggle(event){const checkbox=$(event.target).is(":checkbox")?$(event.target):$(event.target).siblings('input[type="checkbox"]');const pageType=checkbox.closest("[data-page-type]").data("page-type");const urlDisplay=checkbox.closest(".attrua-redirect-toggle").find(".attrua-redirect-url small");const wpUrl=checkbox.data("wp-url");const customUrl=checkbox.data("custom-url");urlDisplay.text(checkbox.prop("checked")?customUrl:wpUrl);$.ajax({url:this.config.ajax_url,type:"POST",data:{action:"attrua_toggle_redirect",_ajax_nonce:this.config.nonce,page_type:pageType,enabled:checkbox.prop("checked")},success:response=>{if(response.success){this.showSuccess(this.config.i18n.settingsSaved)}else{this.showError(response.data.message);checkbox.prop("checked",!checkbox.prop("checked"));urlDisplay.text(checkbox.prop("checked")?customUrl:wpUrl)}},error:()=>{this.showError(this.config.i18n.error);checkbox.prop("checked",!checkbox.prop("checked"));urlDisplay.text(checkbox.prop("checked")?customUrl:wpUrl)}})}handleFormSubmission(event){this.submitButton.prop("disabled",true).val(this.config.i18n.saving);setTimeout(()=>{this.submitButton.prop("disabled",false).val(this.config.i18n.saveChanges)},1e3)}handleAjaxError(button,response){button.prop("disabled",false).text(button.data("original-text")||this.config.i18n.retry);this.showError(response.data?.message||this.config.i18n.error);this.isProcessing=false}showSuccess(message){this.showNotice(message,"success")}showError(message){this.showNotice(message,"error")}showNotice(message,type){this.notificationManager.show(message,type)}getShortCodeTemplate(data){return`
                <div class="attrua-page-control">
                    <div class="attrua-page-shortcode">
                        <span>[attrutes_${this.escapeHtml(data.page_type)}_form]</span>
                        <button type="button" class="attrua-copy-shortcode" data-shortcode="[attrutes_${this.escapeHtml(data.page_type)}_form]"> <i class="ti ti-copy"></i></button>
                    </div>
                </div>
            `}getPageActionsTemplate(data){return`
                <div class="attrua-page-actions">
                    <a href="${this.escapeHtml(data.edit_url)}" class="button">
                        <i class="ti ti-pencil"></i>&nbsp;${this.escapeHtml(this.config.i18n.editPage)}
                    </a>
                    <a href="${this.escapeHtml(data.view_url)}" class="button" target="_blank">
                        <i class="ti ti-eye"></i>&nbsp;${this.escapeHtml(this.config.i18n.viewPage)}
                    </a>
                    <button type="button" 
                            class="button attrua-delete-page"
                            data-page-id="${this.escapeHtml(data.page_id)}"
                            data-page-type="${this.escapeHtml(data.page_type)}">
                        <i class="ti ti-trash"></i>&nbsp;${this.escapeHtml(this.config.i18n.delete)}
                    </button>
                </div>
            `}getPageRedirectTemplate(data){return`
                <label class="attrua-redirect-toggle">
                    <input type="checkbox" 
                           name="attrua_redirect_options[${this.escapeHtml(data.page_type)}]" 
                           value="1"
                           data-wp-url="${this.escapeHtml(data.wp_url||window.attruaAdmin.wpLoginUrl)}"
                           data-custom-url="${this.escapeHtml(data.view_url)}">
                    <span class="slider round"></span>
                    <span class="attrua-redirect-url">
                    <small>${this.escapeHtml(data.wp_url||window.attruaAdmin.wpLoginUrl)}</small>
                    </span>
                </label>
            `}getCreateButtonTemplate(pageType){const config=this.config.pageTypes[pageType]||{};const title=config.title||pageType;const slug=config.slug||pageType;return`
                <button type="button" 
                        class="button attrua-create-page"
                        data-page-type="${this.escapeHtml(pageType)}"
                        data-title="${this.escapeHtml(title)}"
                        data-slug="${this.escapeHtml(slug)}"
                        title="${this.escapeHtml(this.config.i18n.createPageTitle)}">
                    ${this.escapeHtml(this.config.i18n.createPage)}
                </button>
            `}escapeHtml(str){const div=document.createElement("div");div.textContent=str;return div.innerHTML}}class NotificationManager{constructor(){this.init()}init(){if(!document.querySelector(".attrua-notifications-container")){const container=document.createElement("div");container.className="attrua-notifications-container";document.body.appendChild(container)}}show(message,type="success"){const container=document.querySelector(".attrua-notifications-container");const notification=document.createElement("div");const id="notification-"+Date.now();notification.className=`attrua-notification ${type}`;notification.id=id;notification.innerHTML=`
                <div class="attrua-notification-content">
                    ${message}
                    <button class="attrua-notification-dismiss" aria-label="Dismiss">
                        <span class="ti ti-x"></span>
                    </button>
                </div>
            `;container.appendChild(notification);requestAnimationFrame(()=>{notification.classList.add("show")});const dismissButton=notification.querySelector(".attrua-notification-dismiss");dismissButton.addEventListener("click",()=>this.dismiss(id));setTimeout(()=>this.dismiss(id),5e3)}dismiss(id){const notification=document.getElementById(id);if(notification){notification.classList.add("hide");setTimeout(()=>notification.remove(),600)}}}AttributesAdmin.defaults={ajax_url:"",nonce:"",pageTypes:{},i18n:{createPage:"Create Page",createPageTitle:"Create a custom login page",editPage:"Edit Page",viewPage:"View Page",delete:"Delete",creatingPage:"Creating...",deletingPage:"Deleting...",saving:"Saving...",saveChanges:"Save Changes",retry:"Retry",dismiss:"Dismiss this notice",confirmDelete:"Are you sure you want to delete this page?",pageCreated:"Page created successfully.",pageDeleted:"Page deleted successfully.",settingsSaved:"Settings saved.",error:"An error occurred.",invalidData:"Invalid data provided.",redirectToggle:"Redirect WordPress page to this page"}};$(document).ready(function(){if($(".attrua-content-wrap").length){new AttributesAdmin(window.attruaAdmin||{})}});$(".attrua-page-title, .attrua-page-slug").on("change",function(){const input=$(this);const row=input.closest(".attrua-page-row");const pageType=row.data("page-type");const createButton=row.find(".attrua-create-page");if(input.hasClass("attrua-page-title")){createButton.data("title",input.val())}else if(input.hasClass("attrua-page-slug")){createButton.data("slug",input.val())}})})(jQuery);